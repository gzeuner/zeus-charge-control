# ========================= DATASTORE =========================
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:h2:mem:testdb}
spring.datasource.driverClassName=${SPRING_DATASOURCE_DRIVER_CLASS_NAME:org.h2.Driver}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:sa}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:password}
spring.jpa.database-platform=${SPRING_JPA_DATABASE_PLATFORM:org.hibernate.dialect.H2Dialect}
spring.jpa.open-in-view=${SPRING_JPA_OPEN_IN_VIEW:false}
spring.h2.console.enabled=${SPRING_H2_CONSOLE_ENABLED:true}
spring.h2.console.path=${SPRING_H2_CONSOLE_PATH:/h2-console}

# ============================ I18N ============================
spring.messages.basename=messages
spring.messages.encoding=UTF-8

# =========================== SERVER ==========================
server.address=${SERVER_ADDRESS:0.0.0.0}
server.port=${SERVER_PORT:8080}

spring.thymeleaf.prefix=${SPRING_THYMELEAF_PREFIX:classpath:/templates/}
spring.thymeleaf.suffix=${SPRING_THYMELEAF_SUFFIX:.html}
spring.thymeleaf.mode=${SPRING_THYMELEAF_MODE:HTML}
spring.thymeleaf.cache=${SPRING_THYMELEAF_CACHE:false}

# ======================== BATTERY API ========================
battery.url=${BATTERY_URL:}
battery.authToken=${BATTERY_AUTH_TOKEN:}

# Fallback limits (if /api/v2/configurations cannot be read)
battery.inverter.max.watts=${BATTERY_INVERTER_MAX_WATTS:4600}
battery.grid.import.limit.watts=${BATTERY_GRID_IMPORT_LIMIT_WATTS:4600}

# User-Policy & Cache
battery.max.capacity.wh=${BATTERY_MAX_CAPACITY_WH:10000}
battery.target.stateOfCharge=${BATTERY_TARGET_STATE_OF_CHARGE:90}
battery.history.max.entries=${BATTERY_HISTORY_MAX_ENTRIES:24}

battery.status.cache.duration.seconds=${BATTERY_STATUS_CACHE_DURATION_SECONDS:10}
battery.config.cache.duration.seconds=${BATTERY_CONFIG_CACHE_DURATION_SECONDS:300}

# Prefer PV before drawing from the grid
battery.pv.only.enabled=true

# Hold & check intervals
## Re-POST setpoint (only needed if a separate client/server re-post is still used)
battery.hold.interval.seconds=${BATTERY_HOLD_INTERVAL_SECONDS:15}

## MANUAL lease for forced charging (rolling window) 15 min
battery.manual.hold.ms=${BATTERY_MANUAL_HOLD_MS:900000}

## Separate MANUAL lease for idle/1W hold (rolling window) 15 min
battery.manual.idle.hold.ms=${BATTERY_MANUAL_IDLE_HOLD_MS:900000}

## Scheduler: must be shorter than both leases (60 s)
battery.automatic.mode.check.interval=${BATTERY_AUTOMATIC_MODE_CHECK_INTERVAL:30000}

# ================= SCHEDULING & DELAYS ======================
scheduled.job.cron=${SCHEDULED_JOB_CRON:0 15 14,22,2 * * *}
battery.accepted.delay=${BATTERY_ACCEPTED_DELAY:30}

# Optional (with defaults):
weather.sunny-threshold=${WEATHER_SUNNY_THRESHOLD:40}
weather.lookahead.hours=${WEATHER_LOOKAHEAD_HOURS:12}
weather.wait.max.minutes=${WEATHER_WAIT_MAX:120}
weather.wait.min.rsoc=${WEATHER_WAIT_MIN_RSOC:45}
scheduling.wait.max.delay.minutes=${SCHED_WAIT_MAX:120}
# ====== Daytime defer-to-cheaper tuning ======
scheduling.wait.max.defer.hours=${SCHED_WAIT_MAX_DEFER_HOURS:6}
scheduling.wait.min.price.diff.cents=${SCHED_WAIT_MIN_DIFF_CENTS:0.5}
scheduling.wait.relative.drop.pct=${SCHED_WAIT_REL_DROP_PCT:5.0}
scheduling.night.latestStart.offset.minutes=${SCHED_NIGHT_LATEST_START_OFFSET_MIN:60}
scheduling.daytime.lookahead.hours=${SCHED_DAYTIME_LOOKAHEAD_HOURS:12}
# ====== Catch-up start inside active price window ======
scheduling.catchup.enabled=${SCHED_CATCHUP_ENABLED:true}
scheduling.catchup.rsoc.drop.pct=${SCHED_CATCHUP_RSOC_DROP_PCT:5}
scheduling.catchup.max.minutes.from.start=${SCHED_CATCHUP_MAX_MINUTES_FROM_START:90}

# ================= AWATTAR / TIBBER PRICES ===================
awattar.marketdata.url=${AWATTAR_MARKETDATA_URL:https://api.awattar.de/v1/marketdata}
awattar.authToken=${AWATTAR_AUTH_TOKEN:}

tibber.marketdata.url=${TIBBER_MARKETDATA_URL:https://api.tibber.com/v1-beta/gql}
tibber.authToken=${TIBBER_AUTH_TOKEN:}
tibber.query.today=${TIBBER_QUERY_TODAY:{"query": "{viewer {homes {currentSubscription {priceInfo {today {energy startsAt }}}}}}"}}
tibber.query.tomorrow=${TIBBER_QUERY_TOMORROW:{"query": "{viewer {homes {currentSubscription {priceInfo {tomorrow {energy startsAt }}}}}}"}}

marketdata.print=${MARKETDATA_PRINT:false}
marketdata.source=${MARKETDATA_SOURCE:awattar}
marketdata.max.acceptable.price.cents=${MAX_ACCEPTABLE_PRICE_CENTS:15}
marketdata.price.flexibility.threshold=${MARKETDATA_PRICE_FLEXIBILITY_THRESHOLD:2}

# =========================== LOGGING =========================
logging.file.name=${LOGGING_FILE_NAME:logs/power.log}
logging.pattern.file=${LOGGING_PATTERN_FILE:%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n}
logging.file.max-size=${LOGGING_FILE_MAX_SIZE:10MB}
logging.file.max-history=${LOGGING_FILE_MAX_HISTORY:10}
logging.file.total-size-cap=${LOGGING_FILE_TOTAL_SIZE_CAP:100MB}
logging.level.root=${LOGGING_LEVEL_ROOT:INFO}
logging.file.policy=${LOGGING_FILE_POLICY:rolling}

# ========================= NIGHT MODE =========================
night.start=${NIGHT_START:19}
night.end=${NIGHT_END:6}
battery.night.pause.watts=${BATTERY_NIGHT_PAUSE_WATTS:1}
battery.nightChargingIdle=${BATTERY_NIGHT_CHARGING_IDLE:false}

# ========================= WEATHER API ========================
weather.api.base-url=${WEATHER_API_BASE_URL:https://api.open-meteo.com/v1/forecast}
weather.api.enabled=${WEATHER_API_ENABLED:true}
weather.api.latitude=${WEATHER_API_LATITUDE:52.52}
weather.api.longitude=${WEATHER_API_LONGITUDE:13.405}
weather.api.hourly-params=${WEATHER_API_HOURLY_PARAMS:cloudcover}
